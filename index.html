<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const googleSheetURL = "https://script.google.com/macros/s/AKfycbyTQz_iHQonE5aJP74K01vQ72JRlP56rq-Zp7u3lcZy4TGulg-hKwGhJ6uCJLU9wo4/exec";

let chart;
let allData = [];
let lastLiveData = {};

// --- Load historical Google Sheets data ---
async function loadHistoryFromSheet() {
  try {
    const resp = await fetch(googleSheetURL);
    allData = await resp.json();
    drawChart(allData);
  } catch (err) {
    console.error(err);
    alert("Failed to load data from Google Sheets.");
  }
}

// --- Draw chart ---
function drawChart(data) {
  const labels = [];
  const pvTotal = [], output = [], battPower = [], grid = [], load = [], inverter = [];

  data.forEach(dp => {
    const dt = new Date(dp.timestamp);
    labels.push(dt.toLocaleString('en-PH', {hour12:false, timeZone:'Asia/Manila'}));
    pvTotal.push(Number(dp.pv_total_power));
    output.push(Number(dp.output_active_power));
    battPower.push(Number(dp.battery_active_power));
    grid.push(Number(dp.grid_active_power));
    load.push(Number(dp.load_active_power));
    inverter.push(Number(dp.inverter_power));
  });

  if(chart) chart.destroy();

  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'PV Total Power (kW)', data: pvTotal, borderColor: 'green', fill: false },
        { label: 'Battery Power (kW)', data: battPower, borderColor: 'orange', fill: false },
        { label: 'Grid Power (kW)', data: grid, borderColor: 'purple', fill: false },
        { label: 'Load Power (kW)', data: load, borderColor: 'blue', fill: false },
        { label: 'Inverter Power (kW)', data: inverter, borderColor: 'red', fill: false }
      ]
    },
    options: { responsive: true, scales: { x: { display: true } } }
  });
}

// --- Filter chart by datetime range ---
function filterChart() { 
  const startInput = document.getElementById("start").value;
  const endInput = document.getElementById("end").value;
  if (!startInput || !endInput) { drawChart(allData); return; }

  const [startDatePart, startTimePart] = startInput.split("T");
  const [endDatePart, endTimePart] = endInput.split("T");

  const startManila = new Date(`${startDatePart}T${startTimePart}:00+08:00`);
  const endManila   = new Date(`${endDatePart}T${endTimePart}:00+08:00`);

  const filtered = allData.filter(dp => dp.timestamp >= startManila.getTime() && dp.timestamp <= endManila.getTime());
  drawChart(filtered);
}

// --- Clear filter ---
function clearChartFilter() {
  document.getElementById("start").value = "";
  document.getElementById("end").value = "";
  drawChart(allData);
}

// --- Update live readings (from latest row) ---
function refreshRealtime() {
  if(allData.length === 0) return;
  const data = allData[allData.length-1]; // latest row

  document.getElementById("realtime").innerHTML =
    `PV Total Power: ${data.pv_total_power} kW<br>` +
    `PV1 Input Power: ${data.pv1_input_power} kW<br>` +
    `PV2 Input Power: ${data.pv2_input_power} kW<br>` +
    `Load Active Power: ${data.load_active_power} kW<br>` +
    `Grid Active Power: ${data.grid_active_power} kW<br>` +
    `Inverter Power: ${data.inverter_power} kW<br>` +
    `Battery Active Power: ${data.battery_active_power} kW<br>` +
    `Battery Charging Current: ${data.battery_charging_current} A<br>` +
    `Battery Discharging Current: ${data.battery_discharging_current} A<br>` +
    `Battery Voltage: ${data.battery_voltage} V<br>`;

  lastLiveData = {...data};
}

// --- On page load ---
window.onload = async () => {
  await loadHistoryFromSheet();
  refreshRealtime();
  setInterval(refreshRealtime, 10000); // refresh live readings every 10s
};
</script>
</head>
<body>
<h2>ESP32 Solar Dashboard (Google Sheets Data)</h2>

<div id="realtime">Loading live data...</div><br>

<label>Start: <input type="datetime-local" id="start"></label>
<label>End: <input type="datetime-local" id="end"></label>
<button onclick="filterChart()">Apply</button>
<button onclick="clearChartFilter()">Clear</button>

<canvas id="chart" width="800" height="400"></canvas><br>
</body>
</html>

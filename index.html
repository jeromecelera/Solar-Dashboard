<!DOCTYPE html>
<html>
<head>
<style>
  #chart-container {
    width: 100%;
    margin: auto;
    height: 400px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>
let chart;
let allData = [];
let labels = [], pvTotal = [], battCharge = [], battDischarge = [], load = [], inverter = [];
let tooltipTimestamps = [];

// --- Convert Manila timestamp to Date object ---
function manilaDate(ts) {
  // ts is already in Manila time (ms since epoch)
  let dt = new Date(ts);
  // adjust to Manila timezone explicitly for display
  return new Date(dt.toLocaleString("en-US", { timeZone: "Asia/Manila" }));
}

// --- Load historical data from Google Sheets ---
async function loadHistoryFromSheet() {
  try {
    let resp = await fetch("https://script.google.com/macros/s/AKfycbyTQz_iHQonE5aJP74K01vQ72JRlP56rq-Zp7u3lcZy4TGulg-hKwGhJ6uCJLU9wo4/exec");
    if (!resp.ok) throw new Error("Network response not ok");
    allData = await resp.json();
    drawChart(allData);
  } catch (e) {
    console.error("Failed to load history:", e);
    document.getElementById("totals").innerHTML = "No data available.";
    allData = [];
  }
}

// --- Draw chart and calculate totals ---
function drawChart(data) {
    labels = [];
    pvTotal = [];
    battCharge = [];
    battDischarge = [];
    load = [];
    inverter = [];
    tooltipTimestamps = [];

    let pvTotalKWH = 0, battChargeKWH = 0, battDischargeKWH = 0, loadKWH = 0, inverterKWH = 0;

    for (let i = 0; i < data.length; i++) {
        let dp = data[i];
        let dt = manilaDate(dp.timestamp);  // convert timestamp to Manila
        labels.push(dt.toLocaleTimeString('en-PH', { hour12: true, hour: '2-digit', minute: '2-digit' }));
        tooltipTimestamps.push(dp.timestamp);

        pvTotal.push(Number(dp.pv_total_power));
        battCharge.push(Number(dp.battery_charging_power));
        battDischarge.push(Number(dp.battery_discharging_power));
        load.push(Number(dp.load_active_power));
        inverter.push(Number(dp.inverter_power));

        if (i > 0) {
            let dtHours = (dp.timestamp - data[i-1].timestamp) / 3600000.0;
            pvTotalKWH       += dp.pv_total_power * dtHours;
            battChargeKWH    += dp.battery_charging_power * dtHours;
            battDischargeKWH += dp.battery_discharging_power * dtHours;
            loadKWH          += dp.load_active_power * dtHours;
            inverterKWH      += dp.inverter_power * dtHours;
        }
    }

    document.getElementById("totals").innerHTML =
        `<b>KWH Totals (selected range):</b><br>
        PV Total: ${pvTotalKWH.toFixed(3)} kWh<br>
        Battery Charging: ${battChargeKWH.toFixed(3)} kWh<br>
        Battery Discharging: ${battDischargeKWH.toFixed(3)} kWh<br>
        Load: ${loadKWH.toFixed(3)} kWh<br>
        Inverter: ${inverterKWH.toFixed(3)} kWh<br>`;

    if(chart) chart.destroy();
    let maxY = Math.max(...pvTotal, ...battCharge, ...battDischarge, ...load, ...inverter, 10) * 1.2;
    let ctx = document.getElementById('chart').getContext('2d');

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'PV Total Power (kW)', data: pvTotal, borderColor: 'green', fill: false },
                { label: 'Battery Charging (kW)', data: battCharge, borderColor: 'purple', fill: false },
                { label: 'Battery Discharging (kW)', data: battDischarge, borderColor: 'gold', fill: false },
                { label: 'Load Power (kW)', data: load, borderColor: 'blue', fill: false },
                { label: 'Inverter Power (kW)', data: inverter, borderColor: 'red', fill: false }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { display: true, ticks: { autoSkip: true, maxRotation:0, minRotation:0 } },
                y: { display: true, beginAtZero: true, min:0, max:maxY }
            },
            plugins: {
                zoom: { pan:{enabled:true, mode:'x'}, zoom:{wheel:{enabled:true}, pinch:{enabled:true}, mode:'x'} },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            let idx = tooltipItems[0].dataIndex;
                            let dt = manilaDate(tooltipTimestamps[idx]);
                            return dt.toLocaleString('en-PH', {
                                hour12: true, year:'numeric', month:'2-digit', day:'2-digit',
                                hour:'2-digit', minute:'2-digit', second:'2-digit'
                            });
                        },
                        label: function(tooltipItem) {
                            return tooltipItem.dataset.label + ': ' + tooltipItem.formattedValue + ' kW';
                        }
                    }
                }
            }
        }
    });
}

// --- Filter chart by datetime range ---
function filterChart() {
  let startInput = document.getElementById("start").value;
  let endInput   = document.getElementById("end").value;
  if (!startInput || !endInput) { drawChart(allData); return; }

  // convert filter input to Manila timestamp
  let start = new Date(startInput + ":00").getTime(); // assume input is local, add seconds
  let end   = new Date(endInput + ":00").getTime();

  let filtered = allData.filter(dp => dp.timestamp >= start && dp.timestamp <= end);
  drawChart(filtered);
}

function clearChartFilter() {
  document.getElementById("start").value = "";
  document.getElementById("end").value = "";
  drawChart(allData);
}

// --- Clear history ---
async function clearHistory() {
  if (confirm("Are you sure you want to clear history?")) {
    await fetch("https://script.google.com/macros/s/AKfycbyTQz_iHQonE5aJP74K01vQ72JRlP56rq-Zp7u3lcZy4TGulg-hKwGhJ6uCJLU9wo4/exec", {
      method: "POST",
      body: JSON.stringify({ action: "clear" }),
      headers: { "Content-Type": "application/json" }
    });
    allData = [];
    drawChart([]);
    document.getElementById("totals").innerHTML = "History cleared.";
  }
}

// --- On page load ---
window.onload = async () => { await loadHistoryFromSheet(); };
</script>
</head>
<body>
<h2>Solar Dashboard (Google Sheets Data)</h2>

<div id="totals" style="border:1px solid #ccc; padding:10px; width:300px;">
  Loading totals...
</div>
<br>

<label>Start: <input type="datetime-local" id="start"></label>
<label>End: <input type="datetime-local" id="end"></label>
<button onclick="filterChart()">Apply</button>
<button onclick="clearChartFilter()">Clear</button>

<div id="chart-container">
  <canvas id="chart"></canvas>
</div><br>
<button onclick="clearHistory()">Clear History</button>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ESP32 Solar Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  button { margin: 5px; padding: 5px 10px; }
  .tab { cursor: pointer; display: inline-block; padding: 10px; background:#eee; margin-right:5px; }
  .tab.active { background:#ccc; }
  .tab-content { display:none; margin-top:20px; }
  .tab-content.active { display:block; }
</style>
<script>
const googleSheetURL = "https://script.google.com/macros/s/AKfycbyTQz_iHQonE5aJP74K01vQ72JRlP56rq-Zp7u3lcZy4TGulg-hKwGhJ6uCJLU9wo4/exec";

let chart;
let allData = [];
let lastLiveData = {};

function getNumber(row, key) {
  let val = row[key] ?? 0;
  if (typeof val === "string") val = val.replace(/,/g,'');
  let num = parseFloat(val);
  return isNaN(num) ? 0 : num;
}

// ------------------ Load all data from Google Sheets ------------------
async function loadData() {
  try {
    const resp = await fetch(googleSheetURL);
    const sheetData = await resp.json();

    allData = sheetData.map(row => ({
      timestamp: new Date(row.timestamp ?? row['Philippine Time']).getTime(),
      pv_total_power: getNumber(row, 'pv_total_power' ?? 'PV Total Power'),
      pv1_input_power: getNumber(row, 'pv1_input_power' ?? 'PV1 Input Power'),
      pv2_input_power: getNumber(row, 'pv2_input_power' ?? 'PV2 Input Power'),
      load_active_power: getNumber(row, 'load_active_power' ?? 'Load Active Power'),
      grid_active_power: getNumber(row, 'grid_active_power' ?? 'Grid Active Power'),
      battery_active_power: getNumber(row, 'battery_active_power' ?? 'Battery Active Power'),
      battery_charging_current: getNumber(row, 'battery_charging_current' ?? 'Battery Charging Current'),
      battery_discharging_current: getNumber(row, 'battery_discharging_current' ?? 'Battery Discharging Current'),
      battery_voltage: getNumber(row, 'battery_voltage' ?? 'Battery Voltage'),
      inverter_power: getNumber(row, 'inverter_power' ?? 'Inverter Power')
    }));

    updateLiveReadings(allData[allData.length-1] || {});
    drawHistoryChart(allData);
  } catch(err) {
    console.error(err);
    document.getElementById("realtime").innerHTML = "Failed to load live data.";
    document.getElementById("historyChartContainer").innerHTML = "Failed to load history data.";
  }
}

// ------------------ Update live readings ------------------
function updateLiveReadings(data) {
  lastLiveData = {...data};
  document.getElementById("realtime").innerHTML =
    "PV Total Power: " + data.pv_total_power + " kW<br>" +
    "PV1 Input Power: " + data.pv1_input_power + " kW<br>" +
    "PV2 Input Power: " + data.pv2_input_power + " kW<br>" +
    "Load Active Power: " + data.load_active_power + " kW<br>" +
    "Grid Active Power: " + data.grid_active_power + " kW<br>" +
    "Inverter Power: " + data.inverter_power + " kW<br>" +
    "Battery Active Power: " + data.battery_active_power + " kW<br>" +
    "Battery Charging Current: " + data.battery_charging_current + " A<br>" +
    "Battery Discharging Current: " + data.battery_discharging_current + " A<br>" +
    "Battery Voltage: " + data.battery_voltage + " V<br>";
}

// ------------------ Draw history chart ------------------
function drawHistoryChart(data) {
  const labels=[], pvTotal=[], pv1=[], pv2=[], load=[], grid=[], batt=[], inverter=[];

  for (let dp of data) {
    let dt = new Date(dp.timestamp);
    labels.push(dt.toLocaleString('en-PH', {hour12:false, timeZone:'Asia/Manila'}));
    pvTotal.push(dp.pv_total_power);
    pv1.push(dp.pv1_input_power);
    pv2.push(dp.pv2_input_power);
    load.push(dp.load_active_power);
    grid.push(dp.grid_active_power);
    batt.push(dp.battery_active_power);
    inverter.push(dp.inverter_power);
  }

  if(chart) chart.destroy();

  let ctx = document.getElementById('historyChart').getContext('2d');
  chart = new Chart(ctx, {
    type:'line',
    data:{
      labels: labels,
      datasets:[
        {label:'PV Total (kW)', data:pvTotal, borderColor:'green', fill:false},
        {label:'PV1 (kW)', data:pv1, borderColor:'blue', fill:false},
        {label:'PV2 (kW)', data:pv2, borderColor:'orange', fill:false},
        {label:'Load (kW)', data:load, borderColor:'purple', fill:false},
        {label:'Grid (kW)', data:grid, borderColor:'gray', fill:false},
        {label:'Battery (kW)', data:batt, borderColor:'black', fill:false},
        {label:'Inverter (kW)', data:inverter, borderColor:'red', fill:false}
      ]
    },
    options:{responsive:true, scales:{x:{display:true}}}
  });
}

// ------------------ Filter history ------------------
function filterHistory() {
  const startInput = document.getElementById("start").value;
  const endInput = document.getElementById("end").value;
  if (!startInput || !endInput) { drawHistoryChart(allData); return; }

  const start = new Date(startInput+":00+08:00").getTime();
  const end = new Date(endInput+":00+08:00").getTime();

  const filtered = allData.filter(dp => dp.timestamp >= start && dp.timestamp <= end);
  drawHistoryChart(filtered);
}

function clearHistoryFilter() {
  document.getElementById("start").value = "";
  document.getElementById("end").value = "";
  drawHistoryChart(allData);
}

// ------------------ Tabs ------------------
function openTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName+'Tab').classList.add('active');
  document.getElementById(tabName+'Content').classList.add('active');
}

// ------------------ On page load ------------------
window.onload = () => {
  openTab('live');
  loadData();
  setInterval(loadData, 10000); // refresh every 10s
};
</script>
</head>
<body>
<h2>ESP32 Solar Dashboard</h2>

<!-- Tabs -->
<div>
  <div id="liveTab" class="tab" onclick="openTab('live')">Live</div>
  <div id="historyTab" class="tab" onclick="openTab('history')">History</div>
</div>

<!-- Live Tab -->
<div id="liveContent" class="tab-content">
  <div id="realtime">Loading live data...</div>
</div>

<!-- History Tab -->
<div id="historyContent" class="tab-content">
  <label>Start: <input type="datetime-local" id="start"></label>
  <label>End: <input type="datetime-local" id="end"></label>
  <button onclick="filterHistory()">Apply</button>
  <button onclick="clearHistoryFilter()">Clear</button>
  <div id="historyChartContainer">
    <canvas id="historyChart" width="1000" height="400"></canvas>
  </div>
</div>
</body>
</html>

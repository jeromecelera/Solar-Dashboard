<!DOCTYPE html>
<html>
<head>
<style>
  #chart-container {
    width: 100%;
    margin: auto;
    height: 400px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>
let chart;
let allData = [];
let labels = [], pvTotal = [], battCharge = [], battDischarge = [], load = [], inverter = [];
let tooltipTimestamps = []; // store actual timestamps for tooltips

// --- Convert timestamp to Manila time string ---
function formatManila(ts) {
  let dt = new Date(ts);
  // Manila is UTC+8
  let utc = dt.getTime() + dt.getTimezoneOffset()*60000;
  let manila = new Date(utc + 8*3600000);
  
  let year = manila.getFullYear();
  let month = ("0" + (manila.getMonth() + 1)).slice(-2);
  let day = ("0" + manila.getDate()).slice(-2);
  let hour = ("0" + manila.getHours()).slice(-2);
  let min = ("0" + manila.getMinutes()).slice(-2);
  let sec = ("0" + manila.getSeconds()).slice(-2);
  return `${year}-${month}-${day} ${hour}:${min}:${sec}`;
}

// --- Load historical data from Google Sheets ---
async function loadHistoryFromSheet() {
  try {
    let resp = await fetch("https://script.google.com/macros/s/AKfycbyTQz_iHQonE5aJP74K01vQ72JRlP56rq-Zp7u3lcZy4TGulg-hKwGhJ6uCJLU9wo4/exec");
    if (!resp.ok) throw new Error("Network response not ok");
    allData = await resp.json();
    drawChart(allData);
  } catch (e) {
    console.error("Failed to load history:", e);
    document.getElementById("totals").innerHTML = "No data available.";
    allData = [];
  }
}

// --- Draw chart and calculate totals ---
function drawChart(data) {
    labels = [];
    pvTotal = [];
    battCharge = [];
    battDischarge = [];
    load = [];
    inverter = [];
    tooltipTimestamps = [];

    let pvTotalKWH = 0, battChargeKWH = 0, battDischargeKWH = 0, loadKWH = 0, inverterKWH = 0;

    for (let i = 0; i < data.length; i++) {
        let dp = data[i];
        labels.push(formatManila(dp.timestamp)); // Manila time for x-axis
        tooltipTimestamps.push(dp.timestamp);

        pvTotal.push(Number(dp.pv_total_power));
        battCharge.push(Number(dp.battery_charging_power));
        battDischarge.push(Number(dp.battery_discharging_power));
        load.push(Number(dp.load_active_power));
        inverter.push(Number(dp.inverter_power));

        if (i > 0) {
            let dtHours = (dp.timestamp - data[i-1].timestamp) / 3600000.0;
            pvTotalKWH       += dp.pv_total_power * dtHours;
            battChargeKWH    += dp.battery_charging_power * dtHours;
            battDischargeKWH += dp.battery_discharging_power * dtHours;
            loadKWH          += dp.load_active_power * dtHours;
            inverterKWH      += dp.inverter_power * dtHours;
        }
    }

    document.getElementById("totals").innerHTML =
        `<b>KWH Totals (selected range):</b><br>
        PV Total: ${pvTotalKWH.toFixed(3)} kWh<br>
        Battery Charging: ${battChargeKWH.toFixed(3)} kWh<br>
        Battery Discharging: ${battDischargeKWH.toFixed(3)} kWh<br>
        Load: ${loadKWH.toFixed(3)} kWh<br>
        Inverter: ${inverterKWH.toFixed(3)} kWh<br>`;

    if(chart) chart.destroy();
    let maxY = Math.max(...pvTotal, ...battCharge, ...battDischarge, ...load, ...inverter, 10) * 1.2;
    let ctx = document.getElementById('chart').getContext('2d');

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'PV Total Power (kW)', data: pvTotal, borderColor: 'green', fill: false },
                { label: 'Battery Charging (kW)', data: battCharge, borderColor: 'purple', fill: false },
                { label: 'Battery Discharging (kW)', data: battDischarge, borderColor: 'gold', fill: false },
                { label: 'Load Power (kW)', data: load, borderColor: 'blue', fill: false },
                { label: 'Inverter Power (kW)', data: inverter, borderColor: 'red', fill: false }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { display: true, ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 } },
                y: { display: true, beginAtZero: true, min: 0, max: maxY }
            },
            plugins: {
                zoom: {
                    pan: { enabled: true, mode: 'x' },
                    zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            let idx = tooltipItems[0].dataIndex;
                            return formatManila(tooltipTimestamps[idx]);
                        },
                        label: function(tooltipItem) {
                            return tooltipItem.dataset.label + ': ' + tooltipItem.formattedValue + ' kW';
                        }
                    }
                }
            }
        }
    });
}

// --- Filter chart by datetime range (Manila time) ---
function filterChart() {
  let startInput = document.getElementById("start").value;
  let endInput   = document.getElementById("end").value;
  if (!startInput || !endInput) { drawChart(allData); return; }

  // Treat inputs as Manila time (UTC+8)
  let [startDate, startTime] = startInput.split('T');
  let [endDate, endTime] = endInput.split('T');

  let start = new Date(`${startDate}T${startTime}:00+08:00`).getTime();
  let end   = new Date(`${endDate}T${endTime}:00+08:00`).getTime();

  let filtered = allData.filter(dp => dp.timestamp >= start && dp.timestamp <= end);
  drawChart(filtered);
}

function clearChartFilter() {
  document.getElementById("start").value = "";
  document.getElementById("end").value = "";
  drawChart(allData);
}

// --- Clear history ---
async function clearHistory() {
  if (confirm("Are you sure you want to clear history?")) {
    await fetch("https://script.google.com/macros/s/AKfycbyTQz_iHQonE5aJP74K01vQ72JRlP56rq-Zp7u3lcZy4TGulg-hKwGhJ6uCJLU9wo4/exec", {
      method: "POST",
      body: JSON.stringify({ action: "clear" }),
      headers: { "Content-Type": "application/json" }
    });
    allData = [];
    drawChart([]);
    document.getElementById("totals").innerHTML = "History cleared.";
  }
}

// --- On page load ---
window.onload = async () => {
  await loadHistoryFromSheet();
};
</script>
</head>
<body>
<h2>Solar Dashboard (Google Sheets Data)</h2>

<div id="totals" style="border:1px solid #ccc; padding:10px; width:300px;">
  Loading totals...
</div>
<br>

<label>Start: <input type="datetime-local" id="start"></label>
<label>End: <input type="datetime-local" id="end"></label>
<button onclick="filterChart()">Apply</button>
<button onclick="clearChartFilter()">Clear</button>

<div id="chart-container">
  <canvas id="chart"></canvas>
</div><br>
<button onclick="clearHistory()">Clear History</button>
</body>
</html>

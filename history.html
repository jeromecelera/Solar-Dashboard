<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ESP32 Solar History</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  button { margin: 5px; padding: 5px 10px; }
</style>
<script>
const googleSheetURL = "https://script.google.com/macros/s/AKfycbyTQz_iHQonE5aJP74K01vQ72JRlP56rq-Zp7u3lcZy4TGulg-hKwGhJ6uCJLU9wo4/exec";

let chart;
let allData = [];

function getNumber(row, key) {
  let val = row[key] ?? 0;
  if (typeof val === "string") val = val.replace(/,/g,'');
  let num = parseFloat(val);
  return isNaN(num) ? 0 : num;
}

async function loadHistory() {
  try {
    let resp = await fetch(googleSheetURL);
    let sheetData = await resp.json();

    allData = sheetData.map(row => ({
      timestamp: new Date(row.timestamp).getTime(),
      pv_total_power: getNumber(row, 'pv_total_power'),
      pv1_input_power: getNumber(row, 'pv1_input_power'),
      pv2_input_power: getNumber(row, 'pv2_input_power'),
      load_active_power: getNumber(row, 'load_active_power'),
      grid_active_power: getNumber(row, 'grid_active_power'),
      battery_active_power: getNumber(row, 'battery_active_power'),
      battery_charging_current: getNumber(row, 'battery_charging_current'),
      battery_discharging_current: getNumber(row, 'battery_discharging_current'),
      battery_voltage: getNumber(row, 'battery_voltage'),
      inverter_power: getNumber(row, 'inverter_power')
    }));

    drawChart(allData);
  } catch (err) {
    console.error(err);
    document.getElementById("chart-container").innerHTML = "Failed to load data from Google Sheets.";
  }
}

function drawChart(data) {
  let labels=[], pvTotal=[], pv1=[], pv2=[], load=[], grid=[], batt=[], inverter=[];

  for (let dp of data) {
    let dt = new Date(dp.timestamp);
    labels.push(dt.toLocaleString('en-PH', {hour12:false, timeZone:'Asia/Manila'}));
    pvTotal.push(dp.pv_total_power);
    pv1.push(dp.pv1_input_power);
    pv2.push(dp.pv2_input_power);
    load.push(dp.load_active_power);
    grid.push(dp.grid_active_power);
    batt.push(dp.battery_active_power);
    inverter.push(dp.inverter_power);
  }

  if(chart) chart.destroy();

  let ctx = document.getElementById('historyChart').getContext('2d');
  chart = new Chart(ctx, {
    type:'line',
    data:{
      labels: labels,
      datasets:[
        {label:'PV Total (kW)', data:pvTotal, borderColor:'green', fill:false},
        {label:'PV1 (kW)', data:pv1, borderColor:'blue', fill:false},
        {label:'PV2 (kW)', data:pv2, borderColor:'orange', fill:false},
        {label:'Load (kW)', data:load, borderColor:'purple', fill:false},
        {label:'Grid (kW)', data:grid, borderColor:'gray', fill:false},
        {label:'Battery (kW)', data:batt, borderColor:'black', fill:false},
        {label:'Inverter (kW)', data:inverter, borderColor:'red', fill:false}
      ]
    },
    options:{responsive:true, scales:{x:{display:true}}}
  });
}

function filterChart() {
  let startInput = document.getElementById("start").value;
  let endInput = document.getElementById("end").value;
  if (!startInput || !endInput) { drawChart(allData); return; }

  let [startDatePart, startTimePart] = startInput.split("T");
  let [endDatePart, endTimePart] = endInput.split("T");

  let startManila = new Date(`${startDatePart}T${startTimePart}:00+08:00`);
  let endManila = new Date(`${endDatePart}T${endTimePart}:00+08:00`);

  let filtered = allData.filter(dp =>
    dp.timestamp >= startManila.getTime() && dp.timestamp <= endManila.getTime()
  );

  drawChart(filtered);
}

function clearChartFilter() {
  document.getElementById("start").value = "";
  document.getElementById("end").value = "";
  drawChart(allData);
}

window.onload = loadHistory;
</script>
</head>
<body>
<h2>ESP32 Solar History & Graphs</h2>

<label>Start: <input type="datetime-local" id="start"></label>
<label>End: <input type="datetime-local" id="end"></label>
<button onclick="filterChart()">Apply</button>
<button onclick="clearChartFilter()">Clear</button>

<div id="chart-container">
  <canvas id="historyChart" width="1000" height="400"></canvas>
</div>
</body>
</html>
